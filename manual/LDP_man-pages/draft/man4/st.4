.\" Copyright 1995 Robert K. Nichols (Robert.K.Nichols@att.com)
.\" Copyright 1999-2005 Kai Mテ、kisara (Kai.Makisara@kolumbus.fi)
.\"
.\" Permission is granted to make and distribute verbatim copies of this
.\" manual provided the copyright notice and this permission notice are
.\" preserved on all copies.
.\"
.\" Permission is granted to copy and distribute modified versions of this
.\" manual under the conditions for verbatim copying, provided that the
.\" entire resulting derived work is distributed under the terms of a
.\" permission notice identical to this one.
.\"
.\" Since the Linux kernel and libraries are constantly changing, this
.\" manual page may be incorrect or out-of-date.  The author(s) assume no
.\" responsibility for errors or omissions, or for damages resulting from
.\" the use of the information contained herein.  The author(s) may not
.\" have taken the same level of care in the production of this manual,
.\" which is licensed free of charge, as they might when working
.\" professionally.
.\"
.\" Formatted or processed versions of this manual, if unaccompanied by
.\" the source, must acknowledge the copyright and authors of this work.
.\"
.\" Japanese Version Copyright (c) 1998 ISHIKAWA Mutsumi
.\"         all rights reserved.
.\" Translated Tue Feb 10 15:09:29 JST 1998
.\"	by ISHIKAWA Mutsumi <ishikawa@linux.or.jp>
.\" Updated Sun Mar 12 2000 by NAKANO Takeo <nakano@st.seikei.ac.jp>
.\" Updated Sun Apr 24 2005 by NAKANO Takeo <nakano@st.seikei.ac.jp
.\"
.TH ST 4  2010-09-04 "Linux" "Linux Programmer's Manual"
.\"O .SH NAME
.\"O st \- SCSI tape device
.SH 名前
st \- SCSI テープデバイス
.\"O .SH SYNOPSIS
.SH 書式
.nf
.B #include <sys/mtio.h>
.sp
.BI "int ioctl(int " fd ", int " request " [, (void *)" arg3 "]);"
.BI "int ioctl(int " fd ", MTIOCTOP, (struct mtop *)" mt_cmd );
.BI "int ioctl(int " fd ", MTIOCGET, (struct mtget *)" mt_status );
.BI "int ioctl(int " fd ", MTIOCPOS, (struct mtpos *)" mt_pos );
.fi
.\"O .SH DESCRIPTION
.SH 説明
.\"O The
.\"O .B st
.\"O driver provides the interface to a variety of SCSI tape devices.
.\"O Currently, the driver takes control of all detected devices of type
.\"O \(lqsequential-access\(rq.
.\"O The
.\"O .B st
.\"O driver uses major device number 9.
.B st
ドライバーは様々な SCSI テープデバイスのインターフェイスを提供する。
現在では、ドライバーは検出された全ての
\(lqシーケンシャルアクセス (sequential-access) \(rq タイプのデバイスへの
制御を行う。
.B st
ドライバーはメジャーデバイス番号 9 を用いる。
.PP
.\"O Each device uses eight minor device numbers.
.\"O The lowermost five bits
.\"O in the minor numbers are assigned sequentially in the order of
.\"O detection.
.\"O In the 2.6 kernel, the bits above the eight lowermost bits are
.\"O concatenated to the five lowermost bits to form the tape number.
.\"O The minor numbers can be grouped into
.\"O two sets of four numbers: the principal (auto-rewind) minor device numbers,
.\"O .IR n ,
.\"O and the \(lqno-rewind\(rq device numbers,
.\"O .RI ( n " + 128)."
.\"O Devices opened using the principal device number will be sent a
.\"O .BR REWIND
.\"O command when they are closed.
.\"O Devices opened using the \(lqno-rewind\(rq device number will not.
.\"O (Note that using an auto-rewind device for positioning the tape with,
.\"O for instance, mt does not lead to the desired result: the tape is
.\"O rewound after the mt command and the next command starts from the
.\"O beginning of the tape).
それぞれのデバイスは 8 つのマイナーデバイス番号を使う。
マイナー番号の低位側の 5 ビットは、検出された順に割り当てられる。
カーネル 2.6 では、
低位側 8 ビットよりも上位にあるビット群がこの 5 ビットに連結 (concatenate)
され、テーブ番号となる。
マイナー番号は、それぞれ 4 つの数字からなる二つのセットに
グループ分けされる。
基本 (自動巻き戻し) デバイス番号
.IR n 、
および \(lq非巻き戻し (no-rewind) \(rq デバイス番号
.RI ( n " + 128)."
である。
基本デバイス番号を用いてオープンされたデバイスには、
クローズする時に
.B REWIND
コマンドが送られる。
\(lq非巻き戻し\(rq デバイス番号を用いてオープンされた場合は
\s-1REWIND\s+1 コマンドは送られない
(自動巻き戻しデバイスをテープの位置決めに (例えば mt で) 用いても、
望む結果は得られない。テープは mt コマンドの後で巻き戻され、
次のコマンドはテープの先頭から始まってしまう)。
.PP
.\"O Within each group, four minor numbers are available to define
.\"O devices with different characteristics (block size, compression,
.\"O density, etc.)
.\"O When the system starts up, only the first device is
.\"O available.
.\"O The other three are activated when the default
.\"O characteristics are defined (see below).
.\"O (By changing compile-time
.\"O constants, it is possible to change the balance between the maximum
.\"O number of tape drives and the number of minor numbers for each
.\"O drive.
.\"O The default allocation allows control of 32 tape drives.
.\"O For instance, it is possible to control up to 64 tape drives
.\"O with two minor numbers for different options.)
それぞれのグループで、異なった特性 (ブロックサイズ・圧縮・
密度など) のデバイスを定義するために 4 つのマイナー番号が利用できる。
システムが起動したときには、最初のデバイスだけが使える。
他の 3 つはデフォルトの特性が定義されて初めて使えるようになる (後述)。
(コンパイル時の定数を変更することによって、テープドライブの最大数と、
それぞれのドライブに割り当てられるマイナー番号の個数とを調整できる。
デフォルトの割り当てでは 32 台までのテープドライブを制御できる。
例えば 64 台までのテープドライブを、異なったオプションを持つ
二つのマイナー番号で制御するようにもできる。)
.PP
.\"O Devices are typically created by:
デバイスは普通次のように作られる:
.in +4n
.nf

mknod \-m 666 /dev/st0 c 9 0
mknod \-m 666 /dev/st0l c 9 32
mknod \-m 666 /dev/st0m c 9 64
mknod \-m 666 /dev/st0a c 9 96
mknod \-m 666 /dev/nst0 c 9 128
mknod \-m 666 /dev/nst0l c 9 160
mknod \-m 666 /dev/nst0m c 9 192
mknod \-m 666 /dev/nst0a c 9 224
.fi
.in
.PP
.\"O There is no corresponding block device.
これらには対応するブロックデバイスは存在しない。
.PP
.\"O The driver uses an internal buffer that has to be large enough to hold
.\"O at least one tape block.
.\"O In kernels before 2.1.121, the buffer is
.\"O allocated as one contiguous block.
.\"O This limits the block size to the
.\"O largest contiguous block of memory the kernel allocator can provide.
.\"O The limit is currently 128 kB for 32-bit architectures and
.\"O 256 kB for 64-bit architectures.
.\"O In newer kernels the driver
.\"O allocates the buffer in several parts if necessary.
.\"O By default, the
.\"O maximum number of parts is 16.
.\"O This means that the maximum block size
.\"O is very large (2 MB if allocation of 16 blocks of 128 kB succeeds).
ドライバは内部バッファを使い、その大きさは少なくともテープの
1 ブロックを保持できるように取られる。 2.1.121 以前のカーネルでは、
バッファは連続する一つのブロックとして割り当てられる。この方法だと、
ブロックサイズの最大値はカーネルの割り当て可能な連続メモリブロックに
制限される。この制限は 32 ビットアーキテクチャでは 128 kB、
64 ビットアーキテクチャでは 256 kB である。これ以降のカーネルでは、
ドライバは必要に応じていくつかにわかれたバッファを割り当てる。
デフォルトでは 16 個までの部分に分割できる。すなわち
ブロックサイズの最大値は非常に大きい (128 kB のブロック 16 個の
割り当てに成功すれば 2 MB となる)。
.PP
.\"O The driver's internal buffer size is determined by a compile-time
.\"O constant which can be overridden with a kernel startup option.
.\"O In addition to this, the driver tries to allocate a larger temporary
.\"O buffer at run time if necessary.
.\"O However, run-time allocation of large
.\"O contiguous blocks of memory may fail and it is advisable not to rely
.\"O too much on dynamic buffer allocation with kernels older than 2.1.121
.\"O (this applies also to demand-loading the driver with kerneld or kmod).
ドライバの内部バッファのサイズはコンパイル時の定数で定義される。
これはカーネルの起動時オプションによって上書き可能である。
さらにドライバは実行時にも、必要に応じてより大きな一時バッファを
割り当てようとする。しかし実行時に大きな連続メモリブロックを
割り当てようとすると失敗することがあるので、 2.1.121
以前のカーネルでは、動的なバッファ割り当てはあまりあてにしないほうが良い
(これは kerneld や kmod によるドライバのデマンドロードに関しても当てはまる)。
.PP
.\"O The driver does not specifically support any tape drive brand or
.\"O model.
.\"O After system start-up the tape device options are defined by
.\"O the drive firmware.
.\"O For example, if the drive firmware selects fixed-block mode,
.\"O the tape device uses fixed-block mode.
.\"O The options can
.\"O be changed with explicit
.\"O .BR ioctl (2)
.\"O calls and remain in effect when the device is closed and reopened.
.\"O Setting the options affects both the auto-rewind and the nonrewind
.\"O device.
ドライバはドライブのメーカやモデルを特定してサポートするわけではない。
システムが起動すると、テープデバイスのオプションがドライブの
ファームウェアによって定義される。例えば、
ドライブのファームウェアが固定長ブロックモードを選択すれば、
テープデバイスは固定長ブロックモードを使うことになる。このオプションは
.BR ioctl (2)
コールを明示的に使えば変更でき、
その変更はデバイスがクローズされて再びオープンされたときも残る。
.\"nakano: 逆か？
オプションの設定は、
自動巻き戻しデバイスと非巻き戻しデバイスの両方に影響する。
.PP
.\"O Different options can be specified for the different devices within
.\"O the subgroup of four.
.\"O The options take effect when the device is
.\"O opened.
.\"O For example, the system administrator can define
.\"O one device that writes in fixed-block mode with a certain block size,
.\"O and one which writes in variable-block mode (if the drive supports
.\"O both modes).
4 つのサブグループそれぞれのデバイスに対して異なるオプションを
与えることができる。オプションはデバイスがオープンされたときに
効力を発揮する。例えば、システム管理者はあるデバイスを
適当なブロックサイズの固定長ブロックモードで書き込むように定義し、
別のデバイスを可変長ブロックモードで書き込むようにできる (ドライブが
両方のモードをサポートしていれば)。
.PP
.\"O The driver supports
.\"O .B tape partitions
.\"O if they are supported by the drive.
.\"O (Note that the tape partitions
.\"O have nothing to do with disk partitions.
.\"O A partitioned tape can be
.\"O seen as several logical tapes within one medium.)
.\"O Partition support has to be enabled with an
.\"O .BR ioctl (2).
.\"O The tape
.\"O location is preserved within each partition across partition changes.
.\"O The partition used for subsequent tape operations is
.\"O selected with an
.\"O .BR ioctl (2).
.\"O The partition switch is executed together with
.\"O the next tape operation in order to avoid unnecessary tape
.\"O movement.
.\"O The maximum number of partitions on a tape is defined by a
.\"O compile-time constant (originally four).
.\"O The driver contains an
.\"O .BR ioctl (2)
.\"O that can format a tape with either one or two partitions.
このドライバは、
.B テープのパーティション
をサポートしている (ドライブがサポートしている場合)。
(テープのパーティションはディスクパーティションとはなんの関係もない。
パーティション化されたテープは、一つのメディアに複数の論理テープが
存在するかのように見える。)
パーティションのサポートは
.BR ioctl (2)
によって有効にできる。
パーティションが変更されると、
テープの位置はそれぞれのパーティション内部で保存される。
パーティションの選択は
.BR ioctl (2)
で行う。
それ以降のテープ操作の対象は、そのパーティションになる。
パーティションの切り替えは、次のテープ操作と同時に行われ、
不必要なテープ移動をしなくてすむようになっている。
一つのテープにおけるパーティションの最大数は
コンパイル時の定数によって定義される (通常は 4)。
ドライバには、テープの 1 つまたは
2 つのパーティションをフォーマットできるような
.BR ioctl (2)
が用意されている。
.PP
.\"O Device
.\"O .I /dev/tape
.\"O is usually created as a hard or soft link to the default tape device
.\"O on the system.
通常、システムのデフォルトのテープデバイスに対するハードリンク
またはソフトリンクとして、デバイス
.I /dev/tape
が作成される。
.PP
.\"O Starting from kernel 2.6.2, the driver exports in the sysfs directory
.\"O .I /sys/class/scsi_tape
.\"O the attached devices and some parameters assigned to the devices.
カーネル 2.6.2 以降では、このドライバは sysfs ディレクトリ
.I /sys/class/scsi_tape
に、アタッチしたデバイスとそのデバイスに割当てたパラメータをエクスポートする。
.\"O .SS "Data Transfer"
.SS データ転送
.\"O The driver supports operation in both fixed-block mode and
.\"O variable-block mode (if supported by the drive).
.\"O In fixed-block mode the drive
.\"O writes blocks of the specified size and the block size is not
.\"O dependent on the byte counts of the write system calls.
.\"O In variable-block mode one tape block is written for each write call
.\"O and the byte
.\"O count determines the size of the corresponding tape block.
.\"O Note that
.\"O the blocks on the tape don't contain any information about the
.\"O writing mode: when reading, the only important thing is to use
.\"O commands that accept the block sizes on the tape.
このドライバは固定長ブロックモードと可変長ブロックモードの
両方をサポートしている (ドライブがサポートしていれば)。
固定長ブロックモードでは、ドライブは決まったサイズのブロックを
(複数個) 書き込む。このブロックサイズは
write システムコールのバイト数によらない。
可変長ブロックモードでは、
write コールごとに一つのテープブロックに書き込みが行われる。
したがってバイト数が対応するテープブロックのサイズを決める。
テープ上のブロックには、書き込みモードの情報は一切含まれない。
読み込みのときに重要なことは、テープのブロックサイズを受け入れる
コマンドを使うかどうかだけである。
.PP
.\"O In variable-block mode the read byte count does not have to match
.\"O the tape block size exactly.
.\"O If the byte count is larger than the
.\"O next block on tape, the driver returns the data and the function
.\"O returns the actual block size.
.\"O If the block size is larger than the
.\"O byte count, the requested amount of data from the start of the block
.\"O is returned and the rest of the block is discarded.
可変長ブロックモードでは、読み込みバイト数はテープのブロックサイズと
必ずしも一致していなくても良い。バイト数がテープの次のブロックよりも
大きければ、ドライバはそのデータを返し、関数は実際のブロックサイズを返す。
ブロックサイズがバイト数よりも大きければ、要求された分のデータが
ブロックの先頭から読み込まれて返され、ブロックの残りは破棄される。
.PP
.\"O In fixed-block mode the read byte counts can be arbitrary if
.\"O buffering is enabled, or a multiple of the tape block size if
.\"O buffering is disabled.
.\"O Kernels before 2.1.121 allow writes with
.\"O arbitrary byte count if buffering is enabled.
.\"O In all other cases
.\"O (kernel before 2.1.121 with buffering disabled or newer kernel) the
.\"O write byte count must be a multiple of the tape block size.
固定長ブロックモードでは、バッファリングが有効になっていれば
読み込みバイト数は任意の大きさでよい。バッファリングが無効の場合は、
テープのブロックサイズの整数倍でなければならない。 2.1.121 以前の
カーネルでは、バッファリングが有効な場合には
任意のバイト数の書き込みができる。その他の場合すべて
(2.1.121 以前のカーネルでバッファが無効な場合と、新しいカーネルの場合)
では、書き込みバイト数はテープブロックサイズの整数倍でなければならない。
.PP
.\"O In the 2.6 kernel, the driver tries to use direct transfers between the user
.\"O buffer and the device.
.\"O If this is not possible, the driver's internal buffer
.\"O is used.
.\"O The reasons for not using direct transfers include improper alignment
.\"O of the user buffer (default is 512 bytes but this can be changed by the HBA
.\"O driver), one of more pages of the user buffer not reachable by the
.\"O SCSI adapter, etc.
2.6 カーネルでは、このドライバはユーザバッファとデバイス間で、
データの直接転送 (direct transfer) を試みる。
これが不可能な場合は、ドライバの内部バッファを用いる。
直接転送ができない理由としては、ユーザバッファのアラインメントが適切でない
(デフォルトは 512 バイトだが HBA ドライバによって変更されている可能性がある)、
ユーザバッファのページのどれかが SCSI アダプタから見えない、
などが考えられる。
.PP
.\"O A filemark is automatically written to tape if the last tape operation
.\"O before close was a write.
テープをクローズする直前のテープ操作命令が書き込みであれば、
ファイルマークが自動的にテープへ書き込まれる。
.PP
.\"O When a filemark is encountered while reading, the following
.\"O happens.
.\"O If there are data remaining in the buffer when the filemark
.\"O is found, the buffered data is returned.
.\"O The next read returns zero
.\"O bytes.
.\"O The following read returns data from the next file.
.\"O The end of
.\"O recorded data is signaled by returning zero bytes for two consecutive
.\"O read calls.
.\"O The third read returns an error.
読み込み時にファイルマークに出会うと、以下が実行される。
ファイルマークが見付かったときにバッファにデータが残っていると、
バッファのデータが返される。次の読み込み操作は 0 バイトを返す。
その次の読み込みは次のファイルからのデータを返す。
記録データの末尾は、読み込み操作が二回続けて
0 バイトを返して来るかたちで通知される。三回目の読み込みはエラーを返す。
.\"O .SS Ioctls
.SS ioctl
.\"O The driver supports three
.\"O .BR ioctl (2)
.\"O requests.
.\"O Requests not recognized by the
.\"O .B st
.\"O driver are passed to the
.\"O .B SCSI
.\"O driver.
.\"O The definitions below are from
.\"O .IR /usr/include/linux/mtio.h :
ドライバは 3 つの
.BR ioctl (2)
要求をサポートしている。
.B st
ドライバによって認識されなかった要求は
.B SCSI
ドライバにわたされる。
以下の定義は
.I /usr/include/linux/mtio.h
による。
.\"O .SS "MTIOCTOP \(em Perform a tape operation"
.SS "MTIOCTOP \(em テープ操作の実行"
.PP
.\"O This request takes an argument of type
.\"O .IR "(struct mtop *)" .
.\"O Not all drives support all operations.
.\"O The driver returns an
.\"O .B EIO
.\"O error if the drive rejects an operation.
この要求は
.I "(struct mtop *)"
型の引数をとる。全てのドライブが全ての操作をサポートしているわけではない。
ドライブが操作を拒否すると、ドライバは
.B EIO
エラーを返す。
.PP
.in +4n
.nf
/* Structure for MTIOCTOP \- mag tape op command: */
struct mtop {
    short   mt_op;       /* operations defined below */
    int     mt_count;    /* how many of them */
};
.fi
.in
.PP
.\"O Magnetic Tape operations for normal tape use:
通常のテープ利用のための磁気テープ操作:
.TP 14
.B MTBSF
.\"O Backward space over
.\"O .I mt_count
.\"O filemarks.
.I mt_count
個のファイルマーク (filemark) 分の後方スペース (backward space)。
.TP
.B MTBSFM
.\"O Backward space over
.\"O .I mt_count
.\"O filemarks.
.\"O Reposition the tape to the EOT side of the last filemark.
.I mt_count
個のファイルマーク分の後方スペース。
テープの位置を最後のファイルマークの EOT 側に変更する。
.TP
.B MTBSR
.\"O Backward space over
.\"O .I mt_count
.\"O records (tape blocks).
.I mt_count
個のレコード (テープブロック) 分の後方スペース。
.TP
.B MTBSS
.\"O Backward space over
.\"O .I mt_count
.\"O setmarks.
.I mt_count
個のセットマーク分の後方スペース。
.TP
.B MTCOMPRESSION
.\"O Enable compression of tape data within the drive if
.\"O .I mt_count
.\"O is nonzero and disable compression if
.\"O .I mt_count
.\"O is zero.
.\"O This command uses the MODE page 15 supported by most DATs.
.I mt_count
が 0 以外なら、ドライブのデータ圧縮を有効にする。
0 なら圧縮を無効にする。このコマンドは MODE ページ 15 を用いる。
これはほとんどの DAT でサポートされている。
.TP
.B MTEOM
.\"O Go to the end of the recorded media (for appending files).
(ファイルを追加するために) メディアの記録部分の最後まで進める。
.TP
.B MTERASE
.\"O Erase tape.
.\"O With 2.6 kernel, short erase (mark tape empty) is performed if the
.\"O argument is zero.
.\"O Otherwise long erase (erase all) is done.
テープの内容を消去する。
2.6 カーネルでは、引数が 0 ならば short erase (テープが空だと印をつける)
を行う。それ以外の場合は long erase (全体を消去する) を行う。
.TP
.B MTFSF
.\"O Forward space over
.\"O .I mt_count
.\"O filemarks.
.I mt_count
個のファイルマーク分の前方スペース (forward space)。
.TP
.B MTFSFM
.\"O Forward space over
.\"O .I mt_count
.\"O filemarks.
.\"O Reposition the tape to the BOT side of the last filemark.
.I mt_count
個のファイルマーク分の前方スペース。
テープの位置は最後のファイルマークの BOT 側変更される。
.TP
.B MTFSR
.\"O Forward space over
.\"O .I mt_count
.\"O records (tape blocks).
.I mt_count
個のレコード (テープブロック) 分の前方スペース。
.TP
.B MTFSS
.\"O Forward space over
.\"O .I mt_count
.\"O setmarks.
.I mt_count
個のセットマーク分の前方スペース。
.TP
.B MTLOAD
.\"O Execute the SCSI load command.
.\"O A special case is available for some HP
.\"O autoloaders.
.\"O If
.\"O .I mt_count
.\"O is the constant
.\"O .B MT_ST_HPLOADER_OFFSET
.\"O plus a number, the number is
.\"O sent to the drive to control the autoloader.
SCSI ロードコマンドを実行する。 HP オートローダに限って利用できる。
.\"nakano: あってる？
.I mt_count
が定数
.B MT_ST_HPLOADER_OFFSET
とある数値の和である場合、
その数値がドライブに送られ、オートローダの制御に用いられる。
.TP
.B MTLOCK
.\"O Lock the tape drive door.
テープドライブの扉をロックする。
.TP
.B MTMKPART
.\"O Format the tape into one or two partitions.
.\"O If
.\"O .I mt_count
.\"O is nonzero, it gives the size of the first partition and the second
.\"O partition contains the rest of the tape.
.\"O If
.\"O .I mt_count
.\"O is zero, the tape is formatted into one partition.
.\"O This command is not allowed for a drive unless the partition support
.\"O is enabled for the drive (see
.\"O .BR MT_ST_CAN_PARTITIONS
.\"O below).
テープを 1 または 2 パーティションにフォーマットする。
.I mt_count
が 0 でなければ、これが最初のパーティションのサイズを与え、
二番目のパーティションがテープの残りになる。
.I mt_count
が 0 の場合は、テープは一つのパーティションとしてフォーマットされる。
このコマンドは、パーティションのサポートが有効にされた
ドライブでなければ使えない (以下の
.B MT_ST_CAN_PARTITIONS
を見よ)。
.TP
.B MTNOP
.\"O No op\(emflushes the driver's buffer as a side effect.
.\"O Should be used before reading status with
.\"O .BR MTIOCGET .
何も操作を行わない。\(em副次的な効果として、ドライバーのバッファ
をフラッシュする。
.B MTIOCGET
を使って状態を読み出す前にはこの操作を行うべきである。
.TP
.B MTOFFL
.\"O Rewind and put the drive off line.
巻き戻し (rewind) を行い、ドライブをオフライン (off line) にする。
.TP
.B MTRESET
.\"O Reset drive.
ドライブをリセットする。
.TP
.B MTRETEN
.\"O Re-tension tape.
テープをリテンション (re-tension) する
(テープを最後まで巻いた後、最初まで巻き戻す)。
.TP
.B MTREW
.\"O Rewind.
巻き戻し。
.TP
.B MTSEEK
.\"O Seek to the tape block number specified in
.\"O .IR mt_count .
.\"O This operation requires either a SCSI-2 drive that supports the
.\"O .B LOCATE
.\"O command (device-specific address)
.\"O or a Tandberg-compatible SCSI-1 drive (Tandberg, Archive
.\"O Viper, Wangtek, ...).
.\"O The block number should be one that was previously returned by
.\"O .BR MTIOCPOS
.\"O if device-specific addresses are used.
.I mt_count
で指定されたテープブロック番号をシークする。
この操作が行えるのは、 \s-1LOCATE\s+1 コマンド (デバイス固有のアドレス)
をサポートする SCSI-2 ドライブか、あるいは Tandberg
互換の SCSI-1 ドライブ (Tandberg, Archive, Viper, Wangtek,…) である。
デバイス固有のアドレスが利用されている場合は、ブロック番号は
以前に \s-1MTIOCPOS\s+1 によって返されたものにすべきである。
.TP
.B MTSETBLK
.\"O Set the drive's block length to the value specified in
.\"O .IR mt_count .
.\"O A block length of zero sets the drive to variable block size mode.
.I mt_count
の値をドライブのブロック長 (block length) としてセットする。
ブロック長を 0 にするとドライブは可変長ブロックサイズモードにセッ
トされる。
.TP
.B MTSETDENSITY
.\"O Set the tape density to the code in
.\"O .IR mt_count .
.\"O The density codes supported by a drive can be found from the drive
.\"O documentation.
テープ密度 (tape density) を
.I mt_count
で示されるコードに変更する。ドライブでサポートされている密度コード
については、ドライブの文書に書いてあるだろう。
.TP
.B MTSETPART
.\"O The active partition is switched to
.\"O .IR mt_count .
.\"O The partitions are numbered from zero.
.\"O This command is not allowed for
.\"O a drive unless the partition support is enabled for the drive (see
.\"O .B MT_ST_CAN_PARTITIONS
.\"O below).
アクティブなパーティションを第
.I mt_count
番目に切り替える。パーティションは 0 から数える。
このコマンドは、パーティションのサポートが有効にされた
ドライブでなければ使えない (以下の
.B MT_ST_CAN_PARTITIONS
を見よ)。
.TP
.B MTUNLOAD
.\"O Execute the SCSI unload command (does not eject the tape).
SCSI unload コマンドを実行する (テープのイジェクトは行わない)。
.TP
.B MTUNLOCK
.\"O Unlock the tape drive door.
テープドライブの扉のロックを解除する。
.TP
.B MTWEOF
.\"O Write
.\"O .I mt_count
.\"O filemarks.
.I mt_count
個のファイルマークを書き込む。
.TP
.B MTWSM
.\"O Write
.\"O .I mt_count
.\"O setmarks.
.I mt_count
個のセットマークを書き込む。
.PP
.\"O Magnetic Tape operations for setting of device options (by the superuser):
デバイスオプションの設定のための (スーパーユーザによる) 磁気テープ操作:
.TP 8
.B MTSETDRVBUFFER
.\"O Set various drive and driver options according to bits encoded in
.\"O .IR mt_count .
.\"O These consist of the drive's buffering mode, a set of Boolean driver
.\"O options, the buffer write threshold, defaults for the block size and
.\"O density, and timeouts (only in kernels 2.1 and later).
.\"O A single operation can affect only one item in the list above (the
.\"O Booleans counted as one item.)
いろいろなドライブとドライバーのオプションを
.I mt_count
にエンコードされた各ビットに従って設定する。
オプションには、ドライブのバッファリングモード、
ブール値のドライバオプションの集合、
バッファの書き込み閾値 (デフォルトはブロックサイズと密度)、
タイムアウト値が含まれる (カーネル 2.1 以降)。
一回の操作で変えられるのは、上記のリストのどれか一つだけである
(複数のブール値はまとめて一つと勘定される)。
.IP
.\"O A value having zeros in the high-order 4 bits will be used to set the
.\"O drive's buffering mode.
.\"O The buffering modes are:
高位の4ビットがゼロである値は、
ドライブのバッファリングモードの設定に使われる。
バッファリングモードは以下の通り:
.RS 12
.IP 0 4
.\"O The drive will not report
.\"O .BR GOOD
.\"O status on write commands until the data
.\"O blocks are actually written to the medium.
ドライブはライトコマンドに対し、
データブロックが実際に媒体に書き込まれるまで
.B GOOD
のステータスを返さない。
.IP 1
.\"O The drive may report
.\"O .BR GOOD
.\"O status on write commands as soon as all the
.\"O data has been transferred to the drive's internal buffer.
ドライブはライトコマンドに対し、
すべてのデータがドライブの内部バッファに転送されるとすぐに、
.B GOOD
のステータスを返すことができる。
.IP 2
.\"O The drive may report
.\"O .B GOOD
.\"O status on write commands as soon as (a) all
.\"O the data has been transferred to the drive's internal buffer, and
.\"O (b) all buffered data from different initiators has been successfully
.\"O written to the medium.
ライトコマンドに対し、以下の 2 つの条件がそろった場合、
ドライブはすぐに
.B GOOD
ステータスを返す事ができる。
(a) すべてのデータがドライブの内部バッファに転送された。
(b) 別々のイニシエーターから来たバッファデータが、
すべて媒体へ問題なく書き込まれた。
.RE
.IP
.\"O To control the write threshold the value in
.\"O .I mt_count
.\"O must include the constant
.\"O .BR MT_ST_WRITE_THRESHOLD
.\"O bitwise ORed with a block count in the low 28 bits.
.\"O The block count refers to 1024-byte blocks, not the physical block
.\"O size on the tape.
.\"O The threshold cannot exceed the driver's internal buffer size (see
.\"O DESCRIPTION, above).
書き込み閾値を制御するには、
.I mt_count
には、定数 
.B MT_ST_WRITE_THRESHOLD
とブロックカウントのビット毎の OR をとった値を
下位の 28ビットに含まねばならない。
このブロックカウントは 1024 バイトブロックを単位としたもので、
テープの物理ブロックサイズを単位としたものではない。
また、閾値はドライバの内部バッファ (上記の説明参照)
のサイズを越える事はできない。
.IP
.\"O To set and clear the Boolean options
.\"O the value in
.\"O .I mt_count
.\"O must include one of the constants
.\"O .BR MT_ST_BOOLEANS ,
.\"O .BR MT_ST_SETBOOLEANS ,
.\"O .BR MT_ST_CLEARBOOLEANS ,
.\"O or
.\"O .BR MT_ST_DEFBOOLEANS
.\"O bitwise OR'ed with
.\"O whatever combination of the following options is desired.
.\"O Using
.\"O .BR MT_ST_BOOLEANS
.\"O the options can be set to the values
.\"O defined in the corresponding bits.
.\"O With
.\"O .BR MT_ST_SETBOOLEANS
.\"O the options can be selectively set and with
.\"O .BR MT_ST_DEFBOOLEANS
.\"O selectively cleared.
ブール値のフラグを設定・解除するには、
.I mt_count
の値は
.BR MT_ST_BOOLEANS ,
.BR MT_ST_SETBOOLEANS ,
.BR MT_ST_CLEARBOOLEANS ,
.BR MT_ST_DEFBOOLEANS
のいずれか一つの値に、以下のオプションの任意の組み合わせに対して
ビット毎の OR を取ったものを指定する。
.BR MT_ST_BOOLEANS を用いると、
オプションを対応するビットに対して定義されている値に設定できる。
.BR MT_ST_SETBOOLEANS を用いると、
オプションは選択的に設定され、
.BR MT_ST_DEFBOOLEANS を用いると
選択的に解除される。
.IP ""
.\"O The default options for a tape device are set with
.\"O .BR MT_ST_DEFBOOLEANS .
.\"O A nonactive tape device (e.g., device with
.\"O minor 32 or 160) is activated when the default options for it are
.\"O defined the first time.
.\"O An activated device inherits from the device
.\"O activated at start-up the options not set explicitly.
テープデバイスのデフォルトのオプションは
.B MT_ST_DEFBOOLEANS
によって設定される。
アクティブでないテープデバイス (例: マイナー番号 が 32 や 160 のデバイス)
は、それらに対するデフォルトのオプションが最初に定義されたときに
アクティブになる。アクティブにされたデバイスは、
起動時にアクティブにされたデバイスから、
明示的に指定されなかったオプションを継承する。
.IP ""
.\"O The Boolean options are:
ブール値のオプションは以下の通り:
.RS
.TP
.\"O .BR MT_ST_BUFFER_WRITES " (Default: true)"
.BR MT_ST_BUFFER_WRITES " (デフォルト: 真)"
.\"O Buffer all write operations in fixed-block mode.
.\"O If this option is false and the drive uses a fixed block size, then
.\"O all write operations must be for a multiple of the block size.
.\"O This option must be set false to write reliable multivolume archives.
固定長ブロックモードにおけるすべての書き込み操作をバッファリングする。
このオプションが偽であり、かつドライブが固定長ブロックサイズの時は、
すべての書き込み操作はブロックサイズの倍数の大きさで行わなければならない。
信頼性のあるマルチボリュームアーカイブを書き込むためには、
このオプションは偽に設定されていなければならない。
.TP
.\"O .BR MT_ST_ASYNC_WRITES " (Default: true)"
.BR MT_ST_ASYNC_WRITES " (デフォルト: 真)"
.\"O When this option is true, write operations return immediately without
.\"O waiting for the data to be transferred to the drive if the data fits
.\"O into the driver's buffer.
.\"O The write threshold determines how full the buffer must be before a
.\"O new SCSI write command is issued.
.\"O Any errors reported by the drive will be held until the next
.\"O operation.
.\"O This option must be set false to write reliable multivolume archives.
このオプションが真の時には、データがドライバのバッファに収まる時には
データがドライブに転送されるのを待たずに、すぐに書き込み操作が返って来る。
バッファがどのくらい空いたら次の SCSI write コマンドを発行できるかは、
書き込み閾値によって決まる。
ドライブが返すすべてのエラーは、次の操作まで保存される。
信頼性のあるマルチボリュームアーカイブを書き込むためには、
このオプションは偽に設定されていなければならない。
.TP
.\"O .BR MT_ST_READ_AHEAD " (Default: true)"
.BR MT_ST_READ_AHEAD " (デフォルト: 真)"
.\"O This option causes the driver to provide read buffering and
.\"O read-ahead in fixed-block mode.
.\"O If this option is false and the drive uses a fixed block size, then
.\"O all read operations must be for a multiple of the block size.
このオプションを指定すると、
ドライバは固定長ブロックモードで読み込みバッファリングと先読みをするようになる。
このオプションが偽であり、かつドライブが固定長ブロックサイズの時は、
すべての読み込み操作はブロックサイズの倍数の大きさで行わなければならない。
.TP
.\"O .BR MT_ST_TWO_FM " (Default: false)"
.BR MT_ST_TWO_FM " (デフォルト: 偽)"
.\"O This option modifies the driver behavior when a file is closed.
.\"O The normal action is to write a single filemark.
.\"O If the option is true the driver will write two filemarks and
.\"O backspace over the second one.
このオプションはファイルがクローズされた時のドライバーの振舞いを変更する。
一つのファイルマークを書き込むのが通常の動作である。
このオプションが真の時には、
ドライバーは 2 つのファイルマークを書き込んで、
2 つめのファイルマークのところに戻る。
.IP
.\"O Note:
.\"O This option should not be set true for QIC tape drives since they are
.\"O unable to overwrite a filemark.
.\"O These drives detect the end of recorded data by testing for blank tape
.\"O rather than two consecutive filemarks.
.\"O Most other current drives also
.\"O detect the end of recorded data and using two filemarks is usually
.\"O necessary only when interchanging tapes with some other systems.
注意：
QICテープドライブはファイルマークに上書きすることができないので、
このオプションを真にしてはならない。
これらのドライブは記録データの末尾の検知に、
ファイルマークが 2つ続けてあるかではなく、
ブランクテープかどうかのテストを用いる。
現在の他のほとんどのドライブも、記録データの末尾を検知する。
2 つのファイルマークが必要になるのは、
他のシステムとテープをやりとりする場合である。
.TP
.\"O .BR MT_ST_DEBUGGING " (Default: false)"
.BR MT_ST_DEBUGGING " (デフォルト: 偽)"
.\"O This option turns on various debugging messages from the driver
.\"O (effective only if the driver was compiled with
.\"O .B DEBUG
.\"O defined nonzero).
このオプションを真にすると、
ドライバはいろいろなデバッグ用メッセージを出すようになる
.RB ( DEBUG
を非ゼロに定義してドライバをコンパイルしている時のみ有効)。
.TP
.\"O .BR MT_ST_FAST_EOM " (Default: false)"
.BR MT_ST_FAST_EOM " (デフォルト: 偽)"
.\"O This option causes the
.\"O .B MTEOM
.\"O operation to be sent directly to the
.\"O drive, potentially speeding up the operation but causing the driver to
.\"O lose track of the current file number normally returned by the
.\"O .B MTIOCGET
.\"O request.
.\"O If
.\"O .B MT_ST_FAST_EOM
.\"O is false the driver will respond to an
.\"O .B MTEOM
.\"O request by forward spacing over files.
このオプションを真にすると、
.B MTEOM
操作が直接ドライブに送られるようになる。
操作が早くなるはずだが、
ドライバが現在のファイル番号を見失うことになる
(これは通常なら
.B MTIOCGET
リクエストによって返される)。
.B MT_ST_FAST_EOM
が偽の時には、ドライバは
.B MTEOM
リクエストに応えるとき、前方にファイルを一つ一つ進めていく。
.TP
.\"O .BR MT_ST_AUTO_LOCK " (Default: false)"
.BR MT_ST_AUTO_LOCK " (デフォルト: 偽)"
.\"O When this option is true, the drive door is locked when the device is
.\"O opened and unlocked when it is closed.
このオプションが真の時には、
デバイスがオープンされるとドライブの扉がロックされ、
クローズされるとアンロックされる。
.TP
.\"O .BR MT_ST_DEF_WRITES " (Default: false)"
.BR MT_ST_DEF_WRITES " (デフォルト: 偽)"
.\"O The tape options (block size, mode, compression, etc.) may change
.\"O when changing from one device linked to a drive to another device
.\"O linked to the same drive depending on how the devices are
.\"O defined.
.\"O This option defines when the changes are enforced by the
.\"O driver using SCSI-commands and when the drives auto-detection
.\"O capabilities are relied upon.
.\"O If this option is false, the driver
.\"O sends the SCSI-commands immediately when the device is changed.
.\"O If the
.\"O option is true, the SCSI-commands are not sent until a write is
.\"O requested.
.\"O In this case the drive firmware is allowed to detect the
.\"O tape structure when reading and the SCSI-commands are used only to
.\"O make sure that a tape is written according to the correct specification.
テープオプション (ブロックサイズ、モード、圧縮など)
があるドライブにリンクされたデバイスで変更されると、
その同じドライブにリンクされた他のデバイスでも変更されることがある
(そのデバイスの定義による)。このオプションは、
ドライバによる変更をいつ SCSI コマンドによって反映させるかと、
ドライブの自動検知機能がいつ信頼して良いのかを定義する。
このオプションを偽にしておくと、
デバイスの変更があるとドライバはすぐに SCSI コマンドを送る。
真にしておくと、 SCSI コマンドは書き込みが要求されるまで送られない。
後者の場合は、読み込みの際にドライブのファームウェアによって
テープ構造の検知が行える。また SCSI コマンドは、
テープが正しい指定に沿って書き込まれているかどうかの
確認のためだけに用いられる。
.TP
.\"O .BR MT_ST_CAN_BSR " (Default: false)"
.BR MT_ST_CAN_BSR " (デフォルト: 偽)"
.\"O When read-ahead is used, the tape must sometimes be spaced backward to the
.\"O correct position when the device is closed and the SCSI command to
.\"O space backward over records is used for this purpose.
.\"O Some older
.\"O drives can't process this command reliably and this option can be used
.\"O to instruct the driver not to use the command.
.\"O The end result is that,
.\"O with read-ahead and fixed-block mode, the tape may not be correctly
.\"O positioned within a file when the device is closed.
.\"O With 2.6 kernel, the
.\"O default is true for drives supporting SCSI-3.
先読みを使うと、テープをクローズするときに、
場合によってはテープを正しい位置に逆戻ししなければならないことがある。
これには、レコードを越えて逆戻しする SCSI コマンドが用いられる。
古いドライブでは、このコマンド処理の信頼性が低いことがあるが、
このオプションを指定すると、
ドライバにこのコマンドの利用を禁止することができる。
先読みと固定長ブロックモードを用いていると、最終的な結果として、
デバイスのクローズ時にテープが正しい位置にならないことがある。
.\"nakano そうか？
2.6 カーネルでは、SCSI-3 をサポートしているドライブに対して、
この値のデフォルトは真となる。
.TP
.\"O .BR MT_ST_NO_BLKLIMS " (Default: false)"
.BR MT_ST_NO_BLKLIMS " (デフォルト: 偽)"
.\"O Some drives don't accept the
.\"O .B "READ BLOCK LIMITS"
.\"O SCSI command.
.\"O If this is used, the driver does not use the command.
.\"O The drawback is
.\"O that the driver can't check before sending commands if the selected
.\"O block size is acceptable to the drive.
ドライブによっては
.B READ BLOCK LIMITS SCSI
コマンドを受けつけないことがある。
このオプションを用いると、ドライバはこのコマンドを用いない。
欠点は、指定したブロックサイズがドライブに受理されてしまうと、
ドライバのコマンド送信前チェックができなくなる点である。
.TP
.\"O .BR MT_ST_CAN_PARTITIONS " (Default: false)"
.BR MT_ST_CAN_PARTITIONS " (デフォルト: 偽)"
.\"O This option enables support for several partitions within a
.\"O tape.
.\"O The option applies to all devices linked to a drive.
このオプションは、一つのテープに複数パーティションを置くことを
サポートするかどうかを決める。
このオプションはドライブにリンクされた全てのデバイスに適用される。
.TP
.\"O .MT_ST_SCSI2LOGICAL " (Default: false)"
.TP MT_ST_SCSI2LOGICAL " (デフォルト: 偽)"
.\"O This option instructs the driver to use the logical block addresses
.\"O defined in the SCSI-2 standard when performing the seek and tell
.\"O operations (both with
.\"O .B MTSEEK
.\"O and
.\"O .B MTIOCPOS
.\"O commands and when changing tape
.\"O partition).
.\"O Otherwise the device-specific addresses are used.
.\"O It is highly advisable to set this option if the drive supports the
.\"O logical addresses because they count also filemarks.
.\"O There are some
.\"O drives that only support the logical block addresses.
このオプションは、
seek および tell 操作 (両者とも
.BR MTSEEK ・ MTIOCPOS
コマンドを伴い、テープ位置を変更するとき) の際に、
SCSI-2 の標準で定義されている論理ブロックアドレスを用いるかどうかを
ドライバに伝える。
.\"nakano both with の部分怪しい。
偽だとデバイス固有のアドレスが用いられる。
ドライブが論理アドレスをサポートしているときは、
このオプションをセットすることを強く勧める。
このモードではファイルマークもカウントするからである。
論理ブロックアドレスしかサポートしないドライブもいくつか存在している。
.TP
.\"O .BR MT_ST_SYSV " (Default: false)"
.BR MT_ST_SYSV " (デフォルト: 偽)"
.\"O When this option is enabled, the tape devices use the SystemV
.\"O semantics.
.\"O Otherwise the BSD semantics are used.
.\"O The most important
.\"O difference between the semantics is what happens when a device used
.\"O for reading is closed: in System V semantics the tape is spaced forward
.\"O past the next filemark if this has not happened while using the
.\"O device.
.\"O In BSD semantics the tape position is not changed.
このオプションが真になっていると、テープデバイスは
SystemV のルールを用いる。偽だと BSD のルールを用いる。
.\"nakano: semantics → ルール はちと違うか？
これらのルール間の最も大きな違いは、読み込みを行っていた
デバイスがクローズされたときの振舞いである。
System V のルールでは、テープは次のファイルマークを越えて移動する
(デバイスの利用時にこれが行われなかった場合)。
BSD のルールではテープ位置は変更されない。
.TP
.\"O .BR MT_NO_WAIT " (Default: false)"
.BR MT_NO_WAIT " (デフォルト: 偽)"
.\"O Enables immediate mode (i.e., don't wait for the command to finish) for some
.\"O commands (e.g., rewind).
即時モード (immediate mode; コマンドの終了を待たない)
を、ある種のコマンド (rewind など) に対して有効にする。
.PP
.\"O An example:
例:
.in +4n
.nf

struct mtop mt_cmd;
mt_cmd.mt_op = MTSETDRVBUFFER;
mt_cmd.mt_count = MT_ST_BOOLEANS |
        MT_ST_BUFFER_WRITES | MT_ST_ASYNC_WRITES;
ioctl(fd, MTIOCTOP, mt_cmd);
.fi
.in
.RE
.IP ""
.\"O The default block size for a device can be set with
.\"O .B MT_ST_DEF_BLKSIZE
.\"O and the default density code can be set with
.\"O .BR MT_ST_DEFDENSITY .
.\"O The values for the parameters are or'ed
.\"O with the operation code.
デバイスのデフォルトのブロックサイズは
.B MT_ST_DEF_BLKSIZE
によって設定でき、デフォルトの密度コードは
.B MT_ST_DEFDENSITY
によって設定できる。
これらのパラメータの値は操作コードと OR して与える。
.IP ""
.\"O With kernels 2.1.x and later, the timeout values can be set with the
.\"O subcommand
.\"O .B MT_ST_SET_TIMEOUT
.\"O ORed with the timeout in seconds.
.\"O The long timeout (used for rewinds and other commands
.\"O that may take a long time) can be set with
.\"O .BR MT_ST_SET_LONG_TIMEOUT .
.\"O The kernel defaults are very long to
.\"O make sure that a successful command is not timed out with any
.\"O drive.
.\"O Because of this the driver may seem stuck even if it is only
.\"O waiting for the timeout.
.\"O These commands can be used to set more
.\"O practical values for a specific drive.
.\"O The timeouts set for one device
.\"O apply for all devices linked to the same drive.
2.1.x 以降のカーネルでは、タイムアウト値の設定は、
サブコマンド
.B MT_ST_SET_TIMEOUT
に秒単位のタイムアウト値を
OR して与えることによって行える。 long タイムアウト
(巻き戻しなど、長い時間がかかるコマンドに対して用いられる) は
.B MT_ST_SET_LONG_TIMEOUT
で設定できる。
カーネルのデフォルトは非常に長く、どのドライブでも
成功しているコマンドが決してタイムアウトしないようになっている。
したがって、ドライバはタイムアウトを待っているだけなのに、
刺さった (stuck した) ように見えることがある。これらのコマンドを使えば、
特定のドライブに対してもう少し実際的な値に設定することができる。
一つのデバイスに設定したタイムアウト値は、
それと同じドライブにリンクした全てのデバイスに適用される。
.IP ""
.\"O Starting from kernels 2.4.19 and 2.5.43, the driver supports a status
.\"O bit which indicates whether the drive requests cleaning.
.\"O The method used by the
.\"O drive to return cleaning information is set using the
.\"O .B MT_ST_SEL_CLN
.\"O .B subcommand.
.\"O If the value is zero, the cleaning
.\"O bit is always zero.
.\"O If the value is one, the TapeAlert data defined
.\"O in the SCSI-3 standard is used (not yet implemented).
.\"O Values 2-17 are
.\"O reserved.
.\"O If the lowest eight bits are >= 18, bits from the extended
.\"O sense data are used.
.\"O The bits 9-16 specify a mask to select the bits
.\"O to look at and the bits 17-23 specify the bit pattern to look for.
.\"O If the bit pattern is zero, one or more bits under the mask indicate
.\"O the cleaning request.
.\"O If the pattern is nonzero, the pattern must match
.\"O the masked sense data byte.
2.4.19 および 2.5.43 以降のカーネルでは、
このドライバはドライブのクリーニングが必要かどうかを示す
状態ビットをサポートする。
ドライブがクリーニング情報を返させるかどうかは、
.B MT_ST_SEL_CLN
サブコマンドによって設定できる。
この値が 0 だと、クリーニングビットは常に 0 となる。
値を 1 にすると、SCSI-3 標準で規定されている
TapeAlert データが用いられる (まだ実装されていない)
値としては 2 から 17 が予約されている。
低位側の 8 ビットが 18 以上だと、拡張状態データ (extended sense data)
が用いられる。第 9-16 ビットは注目すべきビットを選択するためのマスクを指定し、
第 17-23 ビットは探すべきビットパターンを指定する。
このビットパターンが 0 のときは、
マスク下のビット (群) がクリーニング要求を示す。パターンが 0 でなければ、
このパターンがマスク後の状態データバイトにマッチしなければならない。
.\"O .SS "MTIOCGET \(em Get status"
.SS "MTIOCGET \(em ステータスの取得"
.PP
.\"O This request takes an argument of type
.\"O .IR "(struct mtget *)" .
このリクエストは
.IR "(struct mtget *)"
という型の引数をとる。
.PP
.in +4n
.nf
/* structure for MTIOCGET \- mag tape get status command */
struct mtget {
    long     mt_type;
    long     mt_resid;
    /* the following registers are device dependent */
    long     mt_dsreg;
    long     mt_gstat;
    long     mt_erreg;
    /* The next two fields are not always used */
    daddr_t  mt_fileno;
    daddr_t  mt_blkno;
};
.fi
.in
.IP \fImt_type\fP 11
.\"O The header file defines many values for
.\"O .IR mt_type ,
.\"O but the current driver reports only the generic types
.\"O .B MT_ISSCSI1
.\"O (Generic SCSI-1 tape)
.\"O and
.\"O .B MT_ISSCSI2
.\"O (Generic SCSI-2 tape).
ヘッダファイル中には多くの
.I mt_type
の値が定義されているが、現行のドライバは汎用のタイプである
.B MT_ISSCSI1
(汎用 SCSI-1 テープ) および
.B MT_ISSCSI2
(汎用 SCSI-2 テープ) のみを返す。
.IP \fImt_resid\fP
.\"O contains the current tape partition number.
現在のテープ位置番号。
.IP \fImt_dsreg\fP
.\"O reports the drive's current settings for block size (in the low 24
.\"O bits) and density (in the high 8 bits).
.\"O These fields are defined by
.\"O .BR MT_ST_BLKSIZE_SHIFT ,
.\"O .BR MT_ST_BLKSIZE_MASK ,
.\"O .BR MT_ST_DENSITY_SHIFT ,
.\"O and
.\"O .BR MT_ST_DENSITY_MASK .
ドライブのブロックサイズと密度の現在の設定を報告する
(下位 24 ビットがブロックサイズ、上位 8 ビットが密度)。
これらのフィールドは、
.BR MT_ST_BLKSIZE_SHIFT ,
.BR MT_ST_BLKSIZE_MASK ,
.BR MT_ST_DENSITY_SHIFT ,
.BR MT_ST_DENSITY_MASK
で定義されている。
.IP \fImt_gstat\fP
.\"O reports generic (device independent) status information.
.\"O The header file defines macros for testing these status bits:
汎用の (デバイスに依存しない) ステータスを報告する。
これらのステータスビットをテストするためのマクロが
ヘッダファイルで定義されている。
.RS
.HP 4
\fBGMT_EOF\fP(\fIx\fP):
.\"O The tape is positioned just after a filemark
.\"O (always false after an
.\"O .B MTSEEK
.\"O operation).
テープはファイルマークの直後に位置している。
.RB ( MTSEEK
操作の後では常に偽)
.HP
\fBGMT_BOT\fP(\fIx\fP):
.\"O The tape is positioned at the beginning of the first file (always false
.\"O after an
.\"O .B MTSEEK
.\"O operation).
テープは最初のファイルの先頭に位置している。
.RB ( MTSEEK
操作の後では常に偽)
.HP
\fBGMT_EOT\fP(\fIx\fP):
.\"O A tape operation has reached the physical End Of Tape.
テープ操作はテープの物理的な終点に達した。
.HP
\s-1GMT_SM(\s+1\fIx\fP\s-1)\s+1:
.\"O The tape is currently positioned at a setmark
.\"O (always false after an
.\"O .B MTSEEK
.\"O operation).
テープは現在セットマークに位置している。
.RB ( MTSEEK
操作の後では常に偽)
.HP
\fBGMT_EOD\fP(\fIx\fP):
.\"O The tape is positioned at the end of recorded data.
テープは記録データの末尾に位置している。
.HP
\fBGMT_WR_PROT\fP(\fIx\fP):
.\"O The drive is write-protected.
.\"O For some drives this can also mean that the drive does not support
.\"O writing on the current medium type.
ドライブはライトプロテクトされている。
これはドライブによっては、
ドライブが現在のメディアタイプへの書き込みを
サポートしていない事を意味する場合もある。
.HP
\fBGMT_ONLINE\fP(\fIx\fP):
.\"O The last
.\"O .BR open (2)
.\"O found the drive with a tape in place and ready for operation.
もっとも最近の
.BR open (2)
が、テープが入っていて操作の準備ができているドライブを検知した。
.HP
\fBGMT_D_6250\fP(\fIx\fP), \fBGMT_D_1600\fP(\fIx\fP), \fBGMT_D_800\fP(\fIx\fP):
.\"O This \(lqgeneric\(rq status information reports the current
.\"O density setting for 9-track \(12" tape drives only.
この「汎用」のステータス情報は、
9-トラック \(12" テープドライブの場合にのみ、
現在の密度の設定を報告する。
.HP
\fBGMT_DR_OPEN\fP(\fIx\fP):
.\"O The drive does not have a tape in place.
ドライブにテープが入っていない。
.HP
\fBGMT_IM_REP_EN\fP(\fIx\fP):
.\"O Immediate report mode.
.\"O This bit is set if there are no guarantees that
.\"O the data has been physically written to the tape when the write call
.\"O returns.
.\"O It is set zero only when the driver does not buffer data and
.\"O the drive is set not to buffer data.
即時報告モード。 write コールが戻ったとき、
テープに対して物理的な書き込みが行われたかどうかを保証できない場合に、
このビットがセットされる。ドライバがデータをバッファリングせず、
ドライブもデータをバッファリングしない場合に限って、
この値は 0 にセットされる。
.HP
\fBGMT_CLN\fP(\fIx\fP):
.\"O The drive has requested cleaning.
.\"O Implemented in kernels since 2.4.19 and 2.5.43.
ドライブがクリーニングを要求している。
カーネル 2.4.19 および 2.5.43 以降で実装された。
.RE
.IP \fImt_erreg\fP
.\"O The only field defined in
.\"O .I mt_erreg
.\"O is the recovered error count in the low 16 bits (as defined by
.\"O .BR MT_ST_SOFTERR_SHIFT
.\"O and
.\"O .BR MT_ST_SOFTERR_MASK .
.\"O Due to inconsistencies in the way drives report recovered errors, this
.\"O count is often not maintained (most drives do not by default report
.\"O soft errors but this can be changed with a SCSI MODE SELECT command).
.I mt_erreg
で定義されているフィールドは一つだけで、
下位の 16 ビットがエラーをリカバーした回数である
.RB ( MT_ST_SOFTERR_SHIFT
と
.B MT_ST_SOFTERR_MASK
で定義されている)。
ドライブの報告するエラーリカバー数と矛盾することがあるので、
この数はほとんどの場合維持されない
(ほとんどのドライブでは、デフォルトではソフトエラーを報告しない。
しかしこれは SCSI MODE SELECT コマンドによって変更できる)。
.IP \fImt_fileno\fP
.\"O reports the current file number (zero-based).
.\"O This value is set to \-1 when the file number is unknown (e.g., after
.\"O .BR MTBSS
.\"O or
.\"O .BR MTSEEK ).
(ゼロから数えた) 現在のファイル番号を報告する。
ファイル番号がわからない時 (例えば
.B MTBSS
や
.B MTSEEK
の後など) には \-1 にセットされる。
.IP \fImt_blkno\fP
.\"O reports the block number (zero-based) within the current file.
.\"O This value is set to \-1 when the block number is unknown (e.g., after
.\"O .BR MTBSF ,
.\"O .BR MTBSS ,
.\"O or
.\"O .BR MTSEEK ).
現在のファイル中の(ゼロから数えた)ブロック番号を報告する。
ブロック番号がわからない時 (例えば
.BR MTBSF ,
.BR MTBSS ,
.BR MTSEEK
の後など) には \-1 にセットされる。
.PD
.\"O .SS "MTIOCPOS \(em Get tape position"
.SS "MTIOCPOS \(em テープ位置の取得"
.PP
.\"O This request takes an argument of type
.\"O .I "(struct mtpos *)"
.\"O and reports the drive's notion of the current tape block number,
.\"O which is not the same as
.\"O .I mt_blkno
.\"O returned by
.\"O .BR MTIOCGET .
.\"O This drive must be a SCSI-2 drive that supports the
.\"O .B "READ POSITION"
.\"O command (device-specific address)
.\"O or a Tandberg-compatible SCSI-1 drive (Tandberg, Archive
.\"O Viper, Wangtek, ... ).
このリクエストは
.I "(struct mtpos *)"
型の引数をとり、ドライブが保持している現在のテープブロック番号を報告する。
これは、
.B MTIOCGET
により返される
.I mt_blkno
と同じではない。
ドライブは
.B "READ POSITION"
コマンド (デバイス固有アドレス)
をサポートする SCSI-2ドライブか、
Tandberg 互換の SCSI-1 ドライブ
(Tandberg, Archive, Viper, Wangtek, ... ) でなければならない。
.PP
.in +4n
.nf
/* structure for MTIOCPOS \- mag tape get position command */
struct mtpos {
    long mt_blkno;    /* current block number */
};
.fi
.in
.\"O .SH "RETURN VALUE"
.SH 返り値
.TP 14
.TP
.B EACCES
.\"O An attempt was made to write or erase a write-protected tape.
.\"O (This error is not detected during
.\"O .BR open (2).)
書き込み保護されているテープに書き込みまたは消去を行おうとした。
(このエラーは
.BR open (2)
中には検知されない。)
.TP
.B EBUSY
.\"O The device is already in use or the driver was unable to allocate a
.\"O buffer.
デバイスがすでに使われているか、
ドライバがバッファを割当てられなかった。
.TP
.B EFAULT
.\"O The command parameters point to memory not belonging to the calling
.\"O process.
コマンドの引数が、
呼びだしプロセスに属していないメモリ位置を指している。
.TP
.B EINVAL
.\"O An
.\"O .BR ioctl (2)
.\"O had an invalid argument, or a requested block size was invalid.
.BR ioctl (2)
の引数が不正であるか、要求したブロックサイズが不正。
.TP
.B EIO 14
.\"O The requested operation could not be completed.
要求された操作が最後まで行えなかった。
.TP
.B ENOMEM
.\"O The byte count in
.\"O .BR read (2)
.\"O is smaller than the next physical block on the tape.
.\"O (Before 2.2.18 and 2.4.0-test6 the extra bytes have been
.\"O silently ignored.)
.BR read (2)
のバイト数が、テープにある次の物理ブロックより小さい
(2.2.18 および 2.4.0-test6 以前では、黙って余分のバイトを無視していた)。
.TP
.B ENOSPC
.\"O A write operation could not be completed because the tape reached
.\"O end-of-medium.
メディアの終点に達したため、書き込み操作が完了しなかった。
.TP
.B ENOSYS
.\"O Unknown
.\"O .BR ioctl (2).
不明な
.BR ioctl (2)。
.TP
.B ENXIO
.\"O During opening, the tape device does not exist.
オープンする時にテープデバイスが存在しなかった。
.TP
.B EOVERFLOW
.\"O An attempt was made to read or write a variable-length block that is
.\"O larger than the driver's internal buffer.
ドライバの内部バッファより大きいサイズの可変長ブロックを
読み書きしようとした。
.TP
.B EROFS
.\"O Open is attempted with
.\"O .B O_WRONLY
.\"O or
.\"O .B O_RDWR
.\"O when the tape in the drive is write-protected.
ドライブに入っているテープがライトプロテクトされている場合に、
.B O_WRONLY
または
.B O_RDWR
で open を行おうとした。
.\"O .SH FILES
.SH ファイル
.TP 12
.\"O .I /dev/st*
.\"O the auto-rewind SCSI tape devices
.I /dev/st*
自動巻き戻しの SCSI テープデバイス。
.TP 12
.\"O .I /dev/nst*
.\"O the nonrewind SCSI tape devices
.I /dev/nst*
巻き戻しをしない SCSI テープデバイス。
.\"O .\" .SH AUTHOR
.\" .SH 著者
.\"O .\" The driver has been written by Kai M\(:akisara (Kai.Makisara@metla.fi)
.\"O .\" starting from a driver written by Dwayne Forsyth.
.\"O .\" Several other
.\"O .\" people have also contributed to the driver.
.\" このドライバは
.\" Dwayne Forsyth の書いたドライバをもとにして
.\" Kai M\(:akisara (Kai.Makisara@metla.fi) が書いた。
.\" 他にも何人かの人々がこのドライバに貢献してきた。
.\"O .SH NOTES
.SH 注意
.IP 1. 4
.\"O When exchanging data between systems, both systems have to agree on
.\"O the physical tape block size.
.\"O The parameters of a drive after startup
.\"O are often not the ones most operating systems use with these
.\"O devices.
.\"O Most systems use drives in variable-block mode if the drive
.\"O supports that mode.
.\"O This applies to most modern drives, including
.\"O DATs, 8mm helical scan drives, DLTs, etc.
.\"O It may be advisable to use
.\"O these drives in variable-block mode also in Linux (i.e., use
.\"O .B MTSETBLK
.\"O or
.\"O .B MTSETDEFBLK
.\"O at system startup to set the mode), at least when
.\"O exchanging data with a foreign system.
.\"O The drawback of
.\"O this is that a fairly large tape block size has to be used to get
.\"O acceptable data transfer rates on the SCSI bus.
異なるシステムでデータを相互にやりとりする場合、
両方のシステムで物理的なテープブロックサイズを一致させる必要がある。
起動直後のドライブのパラメータは、大多数の OS がそのデバイスに対して
用いている値と異なっていることもよくある。多くのシステムは、
ドライブが対応していれば可変長ブロックモードを用いる。 DAT、
8mm ヘリカルスキャンドライブ、 DLT などの最近のドライブの
ほとんどは可変長ブロックモードに対応しているから。
これらのドライブは (少なくとも他のシステムとのデータ交換が
ある場合は)、 Linux でも可変長ブロックモードで使うほうが
良いかもしれない (つまりシステムの起動時のモード設定に
.B MTSETBLK
または
.B MTSETDEFBLK
を用いる)。
欠点としては、比較的大きなテープブロックサイズを用いなければ、
SCSI バス上で満足のいく転送速度が得られないことである。
.IP 2.
.\"O Many programs (e.g.,
.\"O .BR tar (1))
.\"O allow the user to specify the blocking
.\"O factor on the command line.
.\"O Note that this determines the physical block
.\"O size on tape only in variable-block mode.
多くのプログラム
.RB ( tar (1)
など) では、
コマンドラインからユーザがブロック関連の値を指定できる。
この値によってテープ上の物理的なブロックサイズを決定できるのは、
可変長ブロックモードに限られることに注意。
.IP 3.
.\"O In order to use SCSI tape drives, the basic SCSI driver,
.\"O a SCSI-adapter driver and the SCSI tape driver must be either
.\"O configured into the kernel or loaded as modules.
.\"O If the SCSI-tape
.\"O driver is not present, the drive is recognized but the tape support
.\"O described in this page is not available.
SCSI テープドライブを用いるには、基本の SCSI ドライバ、
SCSI アダプタのドライバ、 SCSI テープドライバのすべてが
カーネルに組み込まれているか、あるいはモジュールとしてロードされている
必要がある。 SCSI テープドライバがないと、
ドライブは認識されるが、
このページで記述されているテープのサポートは利用できない。
.IP 4.
.\"O The driver writes error messages to the console/log.
.\"O The SENSE
.\"O codes written into some messages are automatically translated to text
.\"O if verbose SCSI messages are enabled in kernel configuration.
ドライバはエラーメッセージをコンソールとログとに書き出す。
カーネル設定で verbose SCSI messages が有効にされていると、
SENSE コードが自動的にテキストに変換されて、
いくつかのメッセージに書きだされる。
.IP 5.
.\"O The driver's internal buffering allows good throughput in fixed-block
.\"O mode also with small
.\"O .BR read (2)
.\"O and
.\"O .BR write (2)
.\"O byte counts.
.\"O With direct transfers
.\"O this is not possible and may cause a surprise when moving to the 2.6
.\"O kernel.
.\"O The solution is to tell the software to use larger transfers (often
.\"O telling it to use larger blocks).
.\"O If this is not possible, direct transfers can be disabled.
このドライバの内部バッファリングは、固定ブロックモードなら
.BR read (2)
や
.BR write (2)
のバイト数が小さくても良いスループットを出す。
直接転送ではこれは不可能なので、2.6 カーネルに移行したときに驚くかもしれない。
解決法としては、ソフトウェアにより大きな転送を行うよう伝える
(たいていはより大きなブロックを使わせる) ことである。
これが不可能なら、直接転送を無効にすることもできる。
.\"O .SH COPYRIGHT
.\" .SH 著作権
.\" Copyright \(co 1995 Robert K. Nichols.
.\" .br
.\" Copyright \(co 1999-2005 Kai M\(:akisara.
.\" .PP
.\" Permission is granted to make and distribute verbatim copies of this
.\" manual provided the copyright notice and this permission notice are
.\" preserved on all copies.
.\" Additional permissions are contained in the header of the source file.
.\"O .SH "SEE ALSO"
.SH 関連項目
.BR mt (1)
.PP
.\"O The file
.\"O .I drivers/scsi/README.st
.\"O or
.\"O .I Documentation/scsi/st.txt
.\"O (kernel >= 2.6) in the kernel sources contains
.\"O the most recent information about the driver and its configuration
.\"O possibilities.
カーネルソースの
.I drivers/scsi/README.st
や
.I Documentation/scsi/st.txt
(カーネル 2.6 以降) の各ファイルには、
ドライバに関するより新しい情報や、
その設定可能な範囲に関する内容が含まれている。
