.\" man2/sched_setaffinity.2 - sched_setaffinity and sched_getaffinity man page
.\"
.\" Copyright (C) 2002 Robert Love
.\" and Copyright (C) 2006 Michael Kerrisk
.\"
.\" This is free documentation; you can redistribute it and/or
.\" modify it under the terms of the GNU General Public License as
.\" published by the Free Software Foundation; either version 2 of
.\" the License, or (at your option) any later version.
.\"
.\" The GNU General Public License's references to "object code"
.\" and "executables" are to be interpreted as the output of any
.\" document formatting or typesetting system, including
.\" intermediate and printed output.
.\"
.\" This manual is distributed in the hope that it will be useful,
.\" but WITHOUT ANY WARRANTY; without even the implied warranty of
.\" MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
.\" GNU General Public License for more details.
.\"
.\" You should have received a copy of the GNU General Public
.\" License along with this manual; if not, write to the Free
.\" Software Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111,
.\" USA.
.\"
.\" 2002-11-19 Robert Love <rml@tech9.net> - initial version
.\" 2004-04-20 mtk - fixed description of return value
.\" 2004-04-22 aeb - added glibc prototype history
.\" 2005-05-03 mtk - noted that sched_setaffinity may cause thread
.\"	migration and that CPU affinity is a per-thread attribute.
.\" 2006-02-03 mtk -- Major rewrite
.\" 2008-11-12, mtk, removed CPU_*() macro descriptions to a
.\" separate CPU_SET(3) page.
.\"
.\" Japanese Version Copyright (c) 2003, 2005 Yuichi SATO
.\"         all rights reserved.
.\" Translated 2003-01-23, Yuichi SATO <ysato444@yahoo.co.jp>
.\" Updated & Modified 2003-09-23, Yuichi SATO
.\" Updated & Modified 2005-01-03, Yuichi SATO
.\" Updated & Modified 2005-09-13, Akihiro MOTOKI <amotoki@dd.iij4u.or.jp>
.\" Updated & Modified 2006-07-14, Akihiro MOTOKI, LDP v2.34
.\" Updated & Modified 2008-12-24, Akihiro MOTOKI, LDP v3.14
.\"
.\"WORD:	affinity		親和度
.\"WORD:	most significant bit	最上位ビット
.\"WORD:	least significant bit	最下位ビット
.\"WORD:	capability		権限
.\"
.TH SCHED_SETAFFINITY 2 2008-11-14 "Linux" "Linux Programmer's Manual"
.\"O .SH NAME
.SH 名前
.\"O sched_setaffinity, sched_getaffinity \- \
.\"O set and get a process's CPU affinity mask
sched_setaffinity, sched_getaffinity \- \
プロセスの CPU affinity マスクを設定・取得する
.\"O .SH SYNOPSIS
.SH 書式
.nf
.B #define _GNU_SOURCE
.B #include <sched.h>
.sp
.BI "int sched_setaffinity(pid_t " pid ", size_t " cpusetsize ,
.BI "                      cpu_set_t *" mask );
.sp
.BI "int sched_getaffinity(pid_t " pid ", size_t " cpusetsize ,
.BI "                      cpu_set_t *" mask );
.fi
.\"O .SH DESCRIPTION
.SH 説明
.\"Osato:
.\"Osato: Kernel ドキュメント IRQ-affinity.txt の訳では、
.\"Osato: "affinity" は「アフィニティ」になっていますが、
.\"Osato: ここに一回だけ訳語 (親和度) を入れておくだけで、
.\"Osato: 特に訳さないことにしようと思います。
.\"Osato:
.\"O A process's CPU affinity mask determines the set of CPUs on which
.\"O it is eligible to run.
.\"O On a multiprocessor system, setting the CPU affinity mask
.\"O can be used to obtain performance benefits.
.\"O For example,
.\"O by dedicating one CPU to a particular process
.\"O (i.e., setting the affinity mask of that process to specify a single CPU,
.\"O and setting the affinity mask of all other processes to exclude that CPU),
.\"O it is possible to ensure maximum execution speed for that process.
.\"O Restricting a process to run on a single CPU also avoids
.\"O the performance cost caused by the cache invalidation that occurs
.\"O when a process ceases to execute on one CPU and then
.\"O recommences execution on a different CPU.
プロセスの CPU affinity (親和度) マスクは、そのプロセスが
実行を許可されている CPU の集合を決定する。
マルチプロセッサ・システムでは、CPU affinity マスクを設定することで
性能上のメリットを得られる可能性がある。
例えば、特定のプロセスを一つの CPU に括り付け
(すなわち、そのプロセスの affinity マスクを一つの CPU に設定し)、
他の全てのプロセスの affinity マスクからその CPU を除外することで、
確実にそのプロセスの実行速度を最大にすることができる。
また、あるプロセスの実行を一つの CPU に限定することで、
一つの CPU での実行を停止してから別の CPU で実行を再開するときに発生する
キャッシュ無効化 (cache invalidation) による性能面の劣化を避けることもできる。

.\"O A CPU affinity mask is represented by the
.\"O .I cpu_set_t
.\"O structure, a "CPU set", pointed to by
.\"O .IR mask .
CPU affinity マスクは「CPU の集合」を表す
.I cpu_set_t
構造体で表現され、
.I cpu_set_t
へのポインタ
.I mask
で指定される。
.\"O A set of macros for manipulating CPU sets is described in
.\"O .BR CPU_SET (3).
CPU 集合を操作するためのマクロ群については
.BR CPU_SET (3)
で記載されている。

.\"O .BR sched_setaffinity ()
.\"O sets the CPU affinity mask of the process whose ID is
.\"O .I pid
.\"O to the value specified by
.\"O .IR mask .
.BR sched_setaffinity ()
は、プロセスID が
.I pid
のプロセスの CPU affinity マスクを
.I mask
で指定された値に設定する。
.\"O If
.\"O .I pid
.\"O is zero, then the calling process is used.
.\"O The argument
.\"O .I cpusetsize
.\"O is the length (in bytes) of the data pointed to by
.\"O .IR mask .
.I pid
が 0 の場合、呼び出し元プロセスが使われる。
.I cpusetsize
引き数には
.I mask
が指すデータの長さ (バイト単位) である。
.\"O Normally this argument would be specified as
.\"O .IR "sizeof(cpu_set_t)" .
通常は、この引き数には
.I "sizeof(cpu_set_t)"
を指定すればよい。

.\"O If the process specified by
.\"O .I pid
.\"O is not currently running on one of the CPUs specified in
.\"O .IR mask ,
.\"O then that process is migrated to one of the CPUs specified in
.\"O .IR mask .
.I pid
で指定されたプロセスが
.I mask
で指定された CPU のいずれかで現在実行されていない場合、
そのプロセスは
.I mask
で指定された CPU のいずれかに移動される。

.\"O .BR sched_getaffinity ()
.\"O writes the affinity mask of the process whose ID is
.\"O .I pid
.\"O into the
.\"O .I cpu_set_t
.\"O structure pointed to by
.\"O .IR mask .
.\"O The
.\"O .I cpusetsize
.\"O argument specifies the size (in bytes) of
.\"O .IR mask .
.BR sched_getaffinity ()
は、
プロセスID が
.I pid
のプロセスの affinity マスクを
.I mask
が指す
.I cpu_set_t
構造体に書き込む。
.I cpusetsize
引き数には
.I mask
の (バイト単位の) 大きさを指定する。

関数
.BR sched_getaffinity ()
は長さ
.I len
のポインタ
.I mask
にプロセス
.I pid
の affinity マスクを書き込む。
.\"O If
.\"O .I pid
.\"O is zero, then the mask of the calling process is returned.
.I pid
が 0 の場合、呼び出し元のプロセスのマスクが返される。
.\"O .SH "RETURN VALUE"
.SH 返り値
.\"O On success,
.\"O .BR sched_setaffinity ()
.\"O and
.\"O .BR sched_getaffinity ()
.\"O return 0.
成功した場合、
.BR sched_setaffinity ()
と
.BR sched_getaffinity ()
は 0 を返す。
.\"O On error, \-1 is returned, and
.\"O .I errno
.\"O is set appropriately.
エラーの場合は \-1 を返し、
.I errno
を適切に設定する。
.\"O .SH ERRORS
.SH エラー
.TP
.B EFAULT
.\"O A supplied memory address was invalid.
指定されたメモリ番地が不正である。
.TP
.B EINVAL
.\"O The affinity bit mask
.\"O .I mask
.\"O contains no processors that are currently physically on the system
.\"O and permitted to the process according to any restrictions that
.\"O may be imposed by the "cpuset" mechanism described in
.\"O .BR cpuset (7).
システム上に現在実際に存在し、かつ
"cpuset" 機構が課す制限においてそのプロセスに対して許可されている
プロセッサが、
affinity ビットマスク
.I mask
に含まれていない。
"cpuset" 機構については
.BR cpuset (7)
を参照。
.TP
.B EINVAL
.\"O .RB ( sched_getaffinity ()
.\"O and, in kernels before 2.6.9,
.\"O .BR sched_setaffinity ())
.\"O .I cpusetsize
.\"O is smaller than the size of the affinity mask used by the kernel.
.RB ( sched_getaffinity ()
と、カーネル 2.6.9 以前の
.BR sched_setaffinity ())
.I cpusetsize
がカーネルで使われている affinity マスクのサイズより小さい。
.TP
.B EPERM
.\"O .RB ( sched_setaffinity ())
.\"O The calling process does not have appropriate privileges.
.\"O The caller needs an effective user ID equal to the user ID
.\"O or effective user ID of the process identified by
.\"O .IR pid ,
.\"O or it must possess the
.\"O .B CAP_SYS_NICE
.\"O capability.
.RB ( sched_setaffinity ())
呼び出し元のプロセスに適切な特権がなかった。
呼び出し元は、実効ユーザ ID が
.I pid
で識別されるプロセスのユーザ ID または実効ユーザ ID と同じであるか、
.B CAP_SYS_NICE
ケーパビリティ (capability) を持たなければならない。
.TP
.B ESRCH
.\"O The process whose ID is \fIpid\fP could not be found.
プロセス ID \fIpid\fP のプロセスが見つからなかった。
.\"O .SH VERSIONS
.SH バージョン
.\"O The CPU affinity system calls were introduced in Linux kernel 2.5.8.
CPU affinity システムコールは Linux kernel 2.5.8 で導入された。
.\"O The system call wrappers were introduced in glibc 2.3.
.\"O Initially, the glibc interfaces included a
.\"O .I cpusetsize
.\"O argument, typed as
.\"O .IR "unsigned int" .
.\"O In glibc 2.3.3, the
.\"O .I cpusetsize
.\"O argument was removed, but was then restored in glibc 2.3.4, with type
.\"O .IR size_t .
これらのシステムコールのラッパー関数は glibc 2.3 で導入された。
最初は、glibc のインタフェースには
.I "unsigned int"
型の
.I cpusetsize
引き数が入っていた。
glibc 2.3.3 では
.I cpusetsize
引き数が削除されたが、glibc 2.3.4 で
.I size_t
型で復活した。
.\"O .SH "CONFORMING TO"
.SH 準拠
.\"O These system calls are Linux-specific.
これらのシステムコールは Linux 固有である。
.\"O .SH "NOTES"
.SH 注意
.\"O After a call to
.\"O .BR sched_setaffinity (),
.\"O the set of CPUs on which the process will actually run is
.\"O the intersection of the set specified in the
.\"O .I mask
.\"O argument and the set of CPUs actually present on the system.
.BR sched_setaffinity ()
を呼び出した後は、プロセスが実際に実行される CPU の集合は、
.I mask
引き数で指定された集合と、システム上に実際に存在する CPU の集合の
共通集合 (AND) となる。
.\"O The system may further restrict the set of CPUs on which the process
.\"O runs if the "cpuset" mechanism described in
.\"O .BR cpuset (7)
.\"O is being used.
.\"O These restrictions on the actual set of CPUs on which the process
.\"O will run are silently imposed by the kernel.
"cpuset" 機構が使用されている場合には、プロセスが動作する CPU 集合
に対してシステムはさらに制限を加えるかもしれない
("cpuset" 機構については
.BR cpuset (7)
を参照)。
プロセスが動作する実際の CPU 集合に対する制限はカーネルにより
暗黙のうちに適用される。

.\"O .BR sched_setscheduler (2)
.\"O has a description of the Linux scheduling scheme.
.BR sched_setscheduler (2)
には Linux におけるスケジューリング機構についての説明がある。
.PP
.\"O The affinity mask is actually a per-thread attribute that can be
.\"O adjusted independently for each of the threads in a thread group.
.\"O The value returned from a call to
.\"O .BR gettid (2)
.\"O can be passed in the argument
.\"O .IR pid .
実際には affinity マスクはスレッド単位の属性で、スレッドグループの
各スレッド単位に独立して調整することができる。
.BR gettid (2)
コールからの返り値をこのコールの
.I pid
引き数として渡すことができる。
.\"O Specifying
.\"O .I pid
.\"O as 0 will set the attribute for the calling thread,
.\"O and passing the value returned from a call to
.\"O .BR getpid (2)
.\"O will set the attribute for the main thread of the thread group.
.\"O (If you are using the POSIX threads API, then use
.\"O .BR pthread_setaffinity_np (3)
.\"O instead of
.\"O .BR sched_setaffinity ().)
.I pid
に 0 を指定すると呼び出し元のスレッドの属性が設定され、
.BR getpid (2)
コールからの返り値を
.I pid
に指定するとスレッドグループのメインスレッドの属性が設定される
(POSIX スレッド API を使用している場合、
.BR sched_setaffinity ()
の代わりに
.BR pthread_setaffinity_np (3)
を使用すること)。

.\"O A child created via
.\"O .BR fork (2)
.\"O inherits its parent's CPU affinity mask.
.\"O The affinity mask is preserved across an
.\"O .BR execve (2).
.BR fork (2)
経由で生成された子プロセスは親プロセスの CPU affinity マスクを継承する。
affinity マスクは
.BR execve (2)
の前後で保存される。

.\"O This manual page describes the glibc interface for the CPU affinity calls.
.\"O The actual system call interface is slightly different, with the
.\"O .I mask
.\"O being typed as
.\"O .IR "unsigned long *" ,
.\"O reflecting the fact that the underlying implementation of CPU
.\"O sets is a simple bit mask.
.\"O On success, the raw
.\"O .BR sched_getaffinity ()
.\"O system call returns the size (in bytes) of the
.\"O .I cpumask_t
.\"O data type that is used internally by the kernel to
.\"O represent the CPU set bit mask.
このマニュアルページでは CPU affinity コールの glibc インタフェースを
説明している。実際のシステムコール・インタフェースは少し違っており、
実際の実装では CPU 集合は簡単なビットマスクであるという実状を反映し、
.I mask
の型が
.IR "unsigned long *"
となっている。
成功時には、生の
.BR sched_getaffinity ()
システムコール自身は
.I cpumask_t
データ型の (バイト単位の) 大きさを返す。
.I cpumask_t
はカーネル内部で CPU 集合のビットマスクを表現するのに
使われているデータ型である。
.\"O .SH "SEE ALSO"
.SH 関連項目
.BR clone (2),
.BR getcpu (2),
.BR getpriority (2),
.BR gettid (2),
.BR nice (2),
.BR sched_get_priority_max (2),
.BR sched_get_priority_min (2),
.BR sched_getscheduler (2),
.BR sched_setscheduler (2),
.BR setpriority (2),
.BR pthread_setaffinity_np (3),
.BR CPU_SET (3),
.BR sched_getcpu (3),
.BR capabilities (7),
.BR cpuset (7)
